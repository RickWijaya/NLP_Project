<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Customer Service</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --primary: #6366f1;
            --primary-hover: #818cf8;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
            --success: #22c55e;
            --error: #ef4444;
            --user-msg: #6366f1;
            --ai-msg: #334155;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        #app {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h2 {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .business-name {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .user-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .user-email {
            font-size: 0.8rem;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
        }

        .logout-btn:hover {
            color: var(--error);
        }

        .auth-prompt {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            text-align: center;
        }

        .auth-prompt p {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .auth-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .auth-buttons button {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .auth-buttons button:hover {
            border-color: var(--primary);
        }

        .auth-buttons button.primary {
            background: var(--primary);
            border-color: var(--primary);
        }

        .new-chat-btn {
            margin: 1rem;
            padding: 0.75rem;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .new-chat-btn:hover {
            background: var(--primary-hover);
        }

        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .session-item {
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-item:hover {
            background: var(--bg-input);
        }

        .session-item.active {
            background: var(--primary);
        }

        .session-title {
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .session-delete {
            opacity: 0;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
        }

        .session-item:hover .session-delete {
            opacity: 1;
        }

        .no-sessions {
            text-align: center;
            color: var(--text-muted);
            padding: 2rem 1rem;
            font-size: 0.85rem;
        }

        /* Main Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .model-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: var(--bg-input);
            border-radius: 4px;
            color: var(--text-muted);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            line-height: 1.5;
        }

        .message.user {
            background: var(--user-msg);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: var(--ai-msg);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            opacity: 0.7;
        }

        .welcome-message {
            text-align: center;
            color: var(--text-muted);
            margin: auto;
        }

        .welcome-message h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        /* Input Area */
        .input-container {
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            gap: 0.75rem;
            max-width: 900px;
            margin: 0 auto;
        }

        .input-wrapper input {
            flex: 1;
            padding: 0.875rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 1rem;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-wrapper button {
            padding: 0.875rem 1.5rem;
            background: var(--primary);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: 500;
        }

        .input-wrapper button:disabled {
            background: var(--bg-input);
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 1rem;
            background: var(--ai-msg);
            border-radius: 12px;
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-6px);
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--border);
        }

        .modal h3 {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal-form input {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95rem;
        }

        .modal-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-form button {
            width: 100%;
            padding: 0.875rem;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
        }

        .modal-form button:hover {
            background: var(--primary-hover);
        }

        .modal-switch {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .modal-switch a {
            color: var(--primary);
            cursor: pointer;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
        }

        .error-message {
            color: var(--error);
            font-size: 0.85rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .error-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100%;
            text-align: center;
            padding: 2rem;
        }

        .error-page h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--error);
        }

        .error-page p {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-input);
            transition: 0.3s;
            border-radius: 22px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: var(--primary);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(18px);
        }

        .input-options {
            display: flex;
            justify-content: flex-end;
            max-width: 900px;
            margin: 0 auto 0.5rem;
            padding: 0 0.5rem;
        }

        /* Source Citations */
        .source-citations {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .source-citations-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .citation {
            display: inline-block;
            background: var(--bg-input);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin: 0.15rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .citation:hover {
            background: var(--primary);
        }

        /* Suggested Questions */
        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .suggestion-btn {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-btn:hover {
            border-color: var(--primary);
            background: var(--primary);
        }
    </style>
</head>

<body>
    <div id="app"></div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="auth-modal">
        <div class="modal" style="position: relative;">
            <button class="modal-close" onclick="closeAuthModal()">√ó</button>
            <h3 id="modal-title">Sign In</h3>
            <div id="modal-error" class="error-message" style="display: none;"></div>
            <form class="modal-form" id="auth-form" onsubmit="handleAuth(event)">
                <input type="email" id="auth-email" placeholder="Email" required>
                <input type="password" id="auth-password" placeholder="Password" required>
                <button type="submit" id="auth-submit">Sign In</button>
            </form>
            <div class="modal-switch" id="modal-switch">
                Don't have an account? <a onclick="switchAuthMode()">Sign Up</a>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';

        // State
        let tenantId = null;
        let businessName = '';
        let currentUser = null;
        let userToken = null;
        let currentSessionId = null;
        let authMode = 'login'; // 'login' or 'register'

        // Get tenant from URL
        const urlParams = new URLSearchParams(window.location.search);
        tenantId = urlParams.get('tenant');

        // Initialize
        async function init() {
            if (!tenantId) {
                showError('No tenant specified', 'Please access this chat via a tenant-specific link (e.g., ?tenant=your_tenant_id)');
                return;
            }

            // Load tenant info
            try {
                const res = await fetch(`${API_BASE}/auth/tenant/${tenantId}/info`);
                if (!res.ok) throw new Error('Tenant not found');
                const data = await res.json();
                businessName = data.business_name;
            } catch (err) {
                showError('Tenant Not Found', `The tenant "${tenantId}" does not exist.`);
                return;
            }

            // Check for saved user session
            const savedToken = localStorage.getItem(`user_token_${tenantId}`);
            const savedUser = localStorage.getItem(`user_data_${tenantId}`);
            if (savedToken && savedUser) {
                userToken = savedToken;
                currentUser = JSON.parse(savedUser);
            }

            // Load anonymous session from localStorage if not logged in
            if (!currentUser) {
                currentSessionId = localStorage.getItem(`anon_session_${tenantId}`);
            }

            renderApp();

            if (currentUser) {
                loadSessions();
            }
        }

        function showError(title, message) {
            document.getElementById('app').innerHTML = `
                <div class="error-page">
                    <h1>‚ö†Ô∏è ${title}</h1>
                    <p>${message}</p>
                </div>
            `;
        }

        function renderApp() {
            document.getElementById('app').innerHTML = `
                <!-- Sidebar -->
                <div class="sidebar">
                    <div class="sidebar-header">
                        <h2>üí¨ ${businessName}</h2>
                        <div class="business-name">Customer Support Chat</div>
                    </div>
                    
                    ${currentUser ? `
                        <div class="user-section">
                            <div class="user-info">
                                <div class="user-avatar">${currentUser.email[0].toUpperCase()}</div>
                                <span class="user-email">${currentUser.email}</span>
                                <button class="logout-btn" onclick="logout()" title="Logout">üö™</button>
                            </div>
                        </div>
                    ` : `
                        <div class="auth-prompt">
                            <p>Sign in to save chat history</p>
                            <div class="auth-buttons">
                                <button onclick="openAuthModal('login')">Sign In</button>
                                <button class="primary" onclick="openAuthModal('register')">Sign Up</button>
                            </div>
                        </div>
                    `}
                    
                    <button class="new-chat-btn" onclick="startNewChat()">
                        ‚ûï New Chat
                    </button>
                    
                    <div class="sessions-list" id="sessions-list">
                        ${currentUser ? '<div class="no-sessions">Loading sessions...</div>' : '<div class="no-sessions">Sign in to view chat history</div>'}
                    </div>
                </div>
                
                <!-- Main Chat Area -->
                <div class="chat-container">
                    <div class="chat-header">
                        <span class="chat-title" id="chat-title">New Conversation</span>
                        <span class="model-badge" id="model-badge">-</span>
                    </div>
                    
                    <div class="messages-container" id="messages">
                        <div class="welcome-message">
                            <h3>üëã Welcome to ${businessName}!</h3>
                            <p>How can we help you today?</p>
                        </div>
                    </div>
                    
                    <div class="input-container">
                        <div class="input-options">
                            <div class="toggle-container">
                                <span>üåê Web Search</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="web-search-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="input-wrapper">
                            <input type="text" id="message-input" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                            <button onclick="sendMessage()" id="send-btn">Send</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Auth functions
        function openAuthModal(mode) {
            authMode = mode;
            document.getElementById('modal-title').textContent = mode === 'login' ? 'Sign In' : 'Create Account';
            document.getElementById('auth-submit').textContent = mode === 'login' ? 'Sign In' : 'Sign Up';
            document.getElementById('modal-switch').innerHTML = mode === 'login'
                ? `Don't have an account? <a onclick="switchAuthMode()">Sign Up</a>`
                : `Already have an account? <a onclick="switchAuthMode()">Sign In</a>`;
            document.getElementById('modal-error').style.display = 'none';
            document.getElementById('auth-form').reset();
            document.getElementById('auth-modal').classList.add('active');
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.remove('active');
        }

        function switchAuthMode() {
            openAuthModal(authMode === 'login' ? 'register' : 'login');
        }

        async function handleAuth(event) {
            event.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('modal-error');

            try {
                const endpoint = authMode === 'login' ? '/auth/user/login' : '/auth/user/register';
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, tenant_id: tenantId })
                });

                const data = await res.json();

                if (!res.ok) {
                    errorEl.textContent = data.detail || 'An error occurred';
                    errorEl.style.display = 'block';
                    return;
                }

                if (authMode === 'register') {
                    // Auto-login after registration
                    openAuthModal('login');
                    document.getElementById('auth-email').value = email;
                    errorEl.textContent = 'Account created! Please sign in.';
                    errorEl.style.color = 'var(--success)';
                    errorEl.style.display = 'block';
                } else {
                    // Save login
                    userToken = data.access_token;
                    currentUser = data.user;
                    localStorage.setItem(`user_token_${tenantId}`, userToken);
                    localStorage.setItem(`user_data_${tenantId}`, JSON.stringify(currentUser));

                    closeAuthModal();
                    renderApp();
                    loadSessions();
                }
            } catch (err) {
                errorEl.textContent = 'Network error. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem(`user_token_${tenantId}`);
            localStorage.removeItem(`user_data_${tenantId}`);
            userToken = null;
            currentUser = null;
            currentSessionId = null;
            renderApp();
        }

        // Session functions
        async function loadSessions() {
            if (!currentUser) return;

            try {
                const res = await fetch(`${API_BASE}/chat/sessions?tenant_id=${tenantId}&user_token=${userToken}`);
                const data = await res.json();

                const list = document.getElementById('sessions-list');

                if (data.sessions && data.sessions.length > 0) {
                    list.innerHTML = data.sessions.map(s => `
                        <div class="session-item ${s.id === currentSessionId ? 'active' : ''}" 
                             onclick="loadSession('${s.id}')">
                            <span class="session-title">${s.title || 'Untitled'}</span>
                            <button class="session-delete" onclick="event.stopPropagation(); deleteSession('${s.id}')">üóëÔ∏è</button>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div class="no-sessions">No chat history yet</div>';
                }
            } catch (err) {
                console.error('Failed to load sessions:', err);
            }
        }

        async function loadSession(sessionId) {
            try {
                const res = await fetch(`${API_BASE}/chat/sessions/${sessionId}?tenant_id=${tenantId}`);
                const data = await res.json();

                currentSessionId = sessionId;
                document.getElementById('chat-title').textContent = data.title || 'Conversation';

                const messagesEl = document.getElementById('messages');
                if (data.messages && data.messages.length > 0) {
                    messagesEl.innerHTML = data.messages.map(m => `
                        <div class="message ${m.role}">
                            ${m.content}
                            ${m.model_used ? `<div class="message-meta">Model: ${m.model_used}</div>` : ''}
                        </div>
                    `).join('');
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                } else {
                    showWelcome();
                }

                loadSessions();
            } catch (err) {
                console.error(err);
            }
        }

        function startNewChat() {
            currentSessionId = null;
            document.getElementById('chat-title').textContent = 'New Conversation';
            document.getElementById('model-badge').textContent = '-';
            showWelcome();

            if (currentUser) {
                document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
            }
        }

        function showWelcome() {
            document.getElementById('messages').innerHTML = `
                <div class="welcome-message">
                    <h3>üëã Welcome to ${businessName}!</h3>
                    <p>How can we help you today?</p>
                </div>
            `;
        }

        async function deleteSession(sessionId) {
            if (!confirm('Delete this chat?')) return;

            try {
                await fetch(`${API_BASE}/chat/sessions/${sessionId}?tenant_id=${tenantId}`, {
                    method: 'DELETE'
                });

                if (currentSessionId === sessionId) {
                    startNewChat();
                }

                loadSessions();
            } catch (err) {
                console.error(err);
            }
        }

        // Chat functions
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message) return;

            input.value = '';

            const messagesEl = document.getElementById('messages');

            // Remove welcome message
            const welcome = messagesEl.querySelector('.welcome-message');
            if (welcome) welcome.remove();

            // Add user message
            messagesEl.innerHTML += `<div class="message user">${message}</div>`;

            // Add typing indicator
            messagesEl.innerHTML += `
                <div class="typing-indicator" id="typing">
                    <span></span><span></span><span></span>
                </div>
            `;
            messagesEl.scrollTop = messagesEl.scrollHeight;

            document.getElementById('send-btn').disabled = true;

            try {
                const enableWebSearch = document.getElementById('web-search-toggle')?.checked || false;

                const res = await fetch(`${API_BASE}/chat/public`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: message,
                        tenant_id: tenantId,
                        session_id: currentSessionId,
                        user_token: userToken,
                        enable_web_search: enableWebSearch
                    })
                });

                const data = await res.json();

                document.getElementById('typing')?.remove();

                if (res.ok) {
                    if (data.session_id) {
                        currentSessionId = data.session_id;

                        // Save anonymous session
                        if (!currentUser) {
                            localStorage.setItem(`anon_session_${tenantId}`, currentSessionId);
                        } else {
                            loadSessions();
                        }
                    }

                    // Build citations HTML
                    let citationsHtml = '';
                    if (data.source_citations && data.source_citations.length > 0) {
                        citationsHtml = `
                            <div class="source-citations">
                                <div class="source-citations-title">üìÑ Sources:</div>
                                ${data.source_citations.map((c, i) =>
                            `<span class="citation" title="${c.excerpt}">[${i + 1}] ${c.filename}</span>`
                        ).join('')}
                            </div>
                        `;
                    }

                    // Build suggestions HTML
                    let suggestionsHtml = '';
                    if (data.suggested_questions && data.suggested_questions.length > 0) {
                        suggestionsHtml = `
                            <div class="suggestions">
                                ${data.suggested_questions.map(q =>
                            `<button class="suggestion-btn" onclick="askSuggestion('${q.replace(/'/g, "\\'")}')">üí° ${q}</button>`
                        ).join('')}
                            </div>
                        `;
                    }

                    messagesEl.innerHTML += `
                        <div class="message assistant">
                            ${data.answer}
                            ${citationsHtml}
                            ${suggestionsHtml}
                            <div class="message-meta">
                                ${data.model_used || ''} ‚Ä¢ ${data.retrieved_chunks?.length || 0} sources ‚Ä¢ ${Math.round(data.processing_time_ms)}ms
                            </div>
                        </div>
                    `;

                    document.getElementById('model-badge').textContent = data.model_used || '-';

                    const title = message.substring(0, 30) + (message.length > 30 ? '...' : '');
                    document.getElementById('chat-title').textContent = title;
                } else {
                    messagesEl.innerHTML += `<div class="message assistant" style="color: var(--error);">Error: ${data.detail || 'Something went wrong'}</div>`;
                }
            } catch (err) {
                document.getElementById('typing')?.remove();
                messagesEl.innerHTML += `<div class="message assistant" style="color: var(--error);">Error: ${err.message}</div>`;
            }

            document.getElementById('send-btn').disabled = false;
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // Handle suggestion button clicks
        function askSuggestion(question) {
            document.getElementById('message-input').value = question;
            sendMessage();
        }

        // Initialize on load
        init();
    </script>
</body>

</html>